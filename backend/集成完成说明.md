# SiliconFlow + Qwen 模型集成完成说明

## ✅ 已完成的集成

### 1. 模型配置
- **Embedding模型**: Qwen/Qwen3-Embedding-4B (2560维)
- **LLM模型**: Qwen/Qwen3-Next-80B-A3B-Instruct (80B参数, 3B激活)
- **API提供商**: SiliconFlow (https://api.siliconflow.cn)

### 2. 修改的文件

#### LightRAG源码 (重要!)
**文件**: `G:\mult_eduagent\Mult_Edu_Agent\LightRAG\lightrag\lightrag.py`
**行号**: 222
**修改**:
```python
# 修改前
tiktoken_model_name: str = field(default="gpt-4o-mini")

# 修改后
tiktoken_model_name: str = field(default="gpt-4")
```

#### 知识库服务
**文件**: `backend/app/services/knowledge_base.py`
**关键配置**:
- Embedding函数: `siliconflow_embed()` - 使用 Qwen3-Embedding-4B
- LLM函数: `siliconflow_llm_complete()` - 使用 Qwen3-Next-80B-A3B-Instruct
- LightRAG初始化: `tokenizer=None` (禁用tiktoken避免pickle错误)
- Embedding维度: `siliconflow_embed.embedding_dim = 2560`

#### 配置文件
**文件**: `backend/app/core/config.py`
**新增**: `SILICONFLOW_API_KEY: Optional[str] = None`

#### 环境变量
**文件**: `backend/.env`
**配置**:
```env
SILICONFLOW_API_KEY=sk-mczrhquoybaxwicxgsfdaereipgbapmtiersywbzkorjogla
```

---

## 🚀 如何启动服务器

### Windows 用户 (推荐)

#### 方法1: 使用启动脚本
```cmd
cd backend
start_server.bat
```

#### 方法2: 手动启动
```cmd
cd backend

:: 第1步: 清除Python缓存 (非常重要!)
python clear_cache.py

:: 第2步: 验证配置
python verify_integration.py

:: 第3步: 启动服务器
python main.py
```

### Linux/Mac 用户
```bash
cd backend

# 清除缓存
python clear_cache.py

# 启动服务器
python main.py
```

---

## ✅ 成功启动的标志

如果看到以下日志,说明启动成功:

```
[RAG Init] Creating LightRAG instance with SiliconFlow embeddings...
[RAG Init] SUCCESS: LightRAG instance created successfully for space 'default'
INFO:nano-vectordb:Init {'embedding_dim': 2560, 'metric': 'cosine'...
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

### 关键成功指标:
- ✅ `[RAG Init] SUCCESS` - LightRAG初始化成功
- ✅ `embedding_dim': 2560` - 向量维度正确
- ✅ `Application startup complete` - 应用启动完成
- ❌ **不应该看到**: `Invalid model_name: gpt-4o-mini` 或 `cannot pickle`

---

## ❌ 如果仍然看到错误

### 错误: `Invalid model_name: gpt-4o-mini`

**原因**: Python使用了旧的缓存文件

**解决方案**:
```cmd
cd backend

:: 1. 停止所有运行的 python main.py 进程 (Ctrl+C 或任务管理器)

:: 2. 删除所有 __pycache__ 目录
python clear_cache.py

:: 3. 重新启动
python main.py
```

### 错误: `cannot pickle 'builtins.CoreBPE' object`

**原因**: LightRAG尝试创建tiktoken tokenizer

**解决方案**: 确认 `knowledge_base.py` 中的 LightRAG 初始化包含 `tokenizer=None`:
```python
self.rag = LightRAG(
    working_dir=str(self.space_dir),
    llm_model_func=siliconflow_llm_complete,
    embedding_func=siliconflow_embed,
    tokenizer=None  # 必须有这一行!
)
```

---

## 📋 验证集成

运行验证脚本检查所有配置:
```cmd
cd backend
python verify_integration.py
```

**期望输出**:
```
[OK] LightRAG版本: 1.4.9
[OK] tiktoken_model_name默认值: gpt-4
[OK] Embedding维度: 2560 (Qwen3-Embedding-4B)
[OK] LLM模型: Qwen/Qwen3-Next-80B-A3B-Instruct
[OK] Tokenizer已禁用
[OK] SILICONFLOW_API_KEY已配置
[OK] LightRAG已成功初始化
```

---

## 🔧 故障排查

### 1. 清除所有Python缓存
```cmd
cd backend
python clear_cache.py
```

### 2. 检查LightRAG源码是否已修改
```cmd
python -c "from lightrag import LightRAG; import inspect; sig = inspect.signature(LightRAG.__init__); print(sig.parameters['tiktoken_model_name'].default)"
```
**应该输出**: `gpt-4` (不是 `gpt-4o-mini`)

### 3. 检查knowledge_base.py配置
```cmd
cd backend/app/services
findstr /C:"tokenizer=None" knowledge_base.py
```
**应该找到**: 2处 `tokenizer=None`

### 4. 重新安装依赖
```cmd
pip install --force-reinstall httpx nest-asyncio
```

---

## 📝 技术细节

### 为什么修改了两个地方?

1. **LightRAG源码** (`lightrag.py:222`):
   - 修改默认的 `tiktoken_model_name` 从 `gpt-4o-mini` 到 `gpt-4`
   - 原因: `gpt-4o-mini` 不被tiktoken识别

2. **知识库服务** (`knowledge_base.py`):
   - 传递 `tokenizer=None` 给LightRAG
   - 原因: 完全避免使用tiktoken,防止pickle错误

### 为什么需要清除缓存?

Python会将编译后的 `.pyc` 文件缓存在 `__pycache__` 目录中。即使修改了源代码,如果不清除缓存,Python可能仍然使用旧版本的代码。

**重要**: 每次修改源代码后,必须:
1. 停止所有运行的Python进程
2. 运行 `python clear_cache.py`
3. 重新启动服务器

---

## 🎉 集成完成

如果所有检查都通过,你现在可以:
1. ✅ 上传文档到知识库
2. ✅ 使用Qwen3-Embedding-4B构建向量索引
3. ✅ 使用Qwen3-Next-80B-A3B-Instruct进行智能问答
4. ✅ 管理多个知识空间

**服务器地址**: http://localhost:8000
**API文档**: http://localhost:8000/docs

---

## 📞 需要帮助?

如果仍然遇到问题,请提供:
1. 完整的错误日志
2. `python verify_integration.py` 的输出
3. 运行 `python main.py` 后的前50行日志
