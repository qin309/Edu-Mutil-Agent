# SiliconFlow + Qwen æ¨¡å‹é›†æˆå®Œæˆè¯´æ˜

## âœ… å·²å®Œæˆçš„é›†æˆ

### 1. æ¨¡å‹é…ç½®
- **Embeddingæ¨¡å‹**: Qwen/Qwen3-Embedding-4B (2560ç»´)
- **LLMæ¨¡å‹**: Qwen/Qwen3-Next-80B-A3B-Instruct (80Bå‚æ•°, 3Bæ¿€æ´»)
- **APIæä¾›å•†**: SiliconFlow (https://api.siliconflow.cn)

### 2. ä¿®æ”¹çš„æ–‡ä»¶

#### LightRAGæºç  (é‡è¦!)
**æ–‡ä»¶**: `G:\mult_eduagent\Mult_Edu_Agent\LightRAG\lightrag\lightrag.py`
**è¡Œå·**: 222
**ä¿®æ”¹**:
```python
# ä¿®æ”¹å‰
tiktoken_model_name: str = field(default="gpt-4o-mini")

# ä¿®æ”¹å
tiktoken_model_name: str = field(default="gpt-4")
```

#### çŸ¥è¯†åº“æœåŠ¡
**æ–‡ä»¶**: `backend/app/services/knowledge_base.py`
**å…³é”®é…ç½®**:
- Embeddingå‡½æ•°: `siliconflow_embed()` - ä½¿ç”¨ Qwen3-Embedding-4B
- LLMå‡½æ•°: `siliconflow_llm_complete()` - ä½¿ç”¨ Qwen3-Next-80B-A3B-Instruct
- LightRAGåˆå§‹åŒ–: `tokenizer=None` (ç¦ç”¨tiktokené¿å…pickleé”™è¯¯)
- Embeddingç»´åº¦: `siliconflow_embed.embedding_dim = 2560`

#### é…ç½®æ–‡ä»¶
**æ–‡ä»¶**: `backend/app/core/config.py`
**æ–°å¢**: `SILICONFLOW_API_KEY: Optional[str] = None`

#### ç¯å¢ƒå˜é‡
**æ–‡ä»¶**: `backend/.env`
**é…ç½®**:
```env
SILICONFLOW_API_KEY=sk-mczrhquoybaxwicxgsfdaereipgbapmtiersywbzkorjogla
```

---

## ğŸš€ å¦‚ä½•å¯åŠ¨æœåŠ¡å™¨

### Windows ç”¨æˆ· (æ¨è)

#### æ–¹æ³•1: ä½¿ç”¨å¯åŠ¨è„šæœ¬
```cmd
cd backend
start_server.bat
```

#### æ–¹æ³•2: æ‰‹åŠ¨å¯åŠ¨
```cmd
cd backend

:: ç¬¬1æ­¥: æ¸…é™¤Pythonç¼“å­˜ (éå¸¸é‡è¦!)
python clear_cache.py

:: ç¬¬2æ­¥: éªŒè¯é…ç½®
python verify_integration.py

:: ç¬¬3æ­¥: å¯åŠ¨æœåŠ¡å™¨
python main.py
```

### Linux/Mac ç”¨æˆ·
```bash
cd backend

# æ¸…é™¤ç¼“å­˜
python clear_cache.py

# å¯åŠ¨æœåŠ¡å™¨
python main.py
```

---

## âœ… æˆåŠŸå¯åŠ¨çš„æ ‡å¿—

å¦‚æœçœ‹åˆ°ä»¥ä¸‹æ—¥å¿—,è¯´æ˜å¯åŠ¨æˆåŠŸ:

```
[RAG Init] Creating LightRAG instance with SiliconFlow embeddings...
[RAG Init] SUCCESS: LightRAG instance created successfully for space 'default'
INFO:nano-vectordb:Init {'embedding_dim': 2560, 'metric': 'cosine'...
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

### å…³é”®æˆåŠŸæŒ‡æ ‡:
- âœ… `[RAG Init] SUCCESS` - LightRAGåˆå§‹åŒ–æˆåŠŸ
- âœ… `embedding_dim': 2560` - å‘é‡ç»´åº¦æ­£ç¡®
- âœ… `Application startup complete` - åº”ç”¨å¯åŠ¨å®Œæˆ
- âŒ **ä¸åº”è¯¥çœ‹åˆ°**: `Invalid model_name: gpt-4o-mini` æˆ– `cannot pickle`

---

## âŒ å¦‚æœä»ç„¶çœ‹åˆ°é”™è¯¯

### é”™è¯¯: `Invalid model_name: gpt-4o-mini`

**åŸå› **: Pythonä½¿ç”¨äº†æ—§çš„ç¼“å­˜æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```cmd
cd backend

:: 1. åœæ­¢æ‰€æœ‰è¿è¡Œçš„ python main.py è¿›ç¨‹ (Ctrl+C æˆ–ä»»åŠ¡ç®¡ç†å™¨)

:: 2. åˆ é™¤æ‰€æœ‰ __pycache__ ç›®å½•
python clear_cache.py

:: 3. é‡æ–°å¯åŠ¨
python main.py
```

### é”™è¯¯: `cannot pickle 'builtins.CoreBPE' object`

**åŸå› **: LightRAGå°è¯•åˆ›å»ºtiktoken tokenizer

**è§£å†³æ–¹æ¡ˆ**: ç¡®è®¤ `knowledge_base.py` ä¸­çš„ LightRAG åˆå§‹åŒ–åŒ…å« `tokenizer=None`:
```python
self.rag = LightRAG(
    working_dir=str(self.space_dir),
    llm_model_func=siliconflow_llm_complete,
    embedding_func=siliconflow_embed,
    tokenizer=None  # å¿…é¡»æœ‰è¿™ä¸€è¡Œ!
)
```

---

## ğŸ“‹ éªŒè¯é›†æˆ

è¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥æ‰€æœ‰é…ç½®:
```cmd
cd backend
python verify_integration.py
```

**æœŸæœ›è¾“å‡º**:
```
[OK] LightRAGç‰ˆæœ¬: 1.4.9
[OK] tiktoken_model_nameé»˜è®¤å€¼: gpt-4
[OK] Embeddingç»´åº¦: 2560 (Qwen3-Embedding-4B)
[OK] LLMæ¨¡å‹: Qwen/Qwen3-Next-80B-A3B-Instruct
[OK] Tokenizerå·²ç¦ç”¨
[OK] SILICONFLOW_API_KEYå·²é…ç½®
[OK] LightRAGå·²æˆåŠŸåˆå§‹åŒ–
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### 1. æ¸…é™¤æ‰€æœ‰Pythonç¼“å­˜
```cmd
cd backend
python clear_cache.py
```

### 2. æ£€æŸ¥LightRAGæºç æ˜¯å¦å·²ä¿®æ”¹
```cmd
python -c "from lightrag import LightRAG; import inspect; sig = inspect.signature(LightRAG.__init__); print(sig.parameters['tiktoken_model_name'].default)"
```
**åº”è¯¥è¾“å‡º**: `gpt-4` (ä¸æ˜¯ `gpt-4o-mini`)

### 3. æ£€æŸ¥knowledge_base.pyé…ç½®
```cmd
cd backend/app/services
findstr /C:"tokenizer=None" knowledge_base.py
```
**åº”è¯¥æ‰¾åˆ°**: 2å¤„ `tokenizer=None`

### 4. é‡æ–°å®‰è£…ä¾èµ–
```cmd
pip install --force-reinstall httpx nest-asyncio
```

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä¿®æ”¹äº†ä¸¤ä¸ªåœ°æ–¹?

1. **LightRAGæºç ** (`lightrag.py:222`):
   - ä¿®æ”¹é»˜è®¤çš„ `tiktoken_model_name` ä» `gpt-4o-mini` åˆ° `gpt-4`
   - åŸå› : `gpt-4o-mini` ä¸è¢«tiktokenè¯†åˆ«

2. **çŸ¥è¯†åº“æœåŠ¡** (`knowledge_base.py`):
   - ä¼ é€’ `tokenizer=None` ç»™LightRAG
   - åŸå› : å®Œå…¨é¿å…ä½¿ç”¨tiktoken,é˜²æ­¢pickleé”™è¯¯

### ä¸ºä»€ä¹ˆéœ€è¦æ¸…é™¤ç¼“å­˜?

Pythonä¼šå°†ç¼–è¯‘åçš„ `.pyc` æ–‡ä»¶ç¼“å­˜åœ¨ `__pycache__` ç›®å½•ä¸­ã€‚å³ä½¿ä¿®æ”¹äº†æºä»£ç ,å¦‚æœä¸æ¸…é™¤ç¼“å­˜,Pythonå¯èƒ½ä»ç„¶ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ä»£ç ã€‚

**é‡è¦**: æ¯æ¬¡ä¿®æ”¹æºä»£ç å,å¿…é¡»:
1. åœæ­¢æ‰€æœ‰è¿è¡Œçš„Pythonè¿›ç¨‹
2. è¿è¡Œ `python clear_cache.py`
3. é‡æ–°å¯åŠ¨æœåŠ¡å™¨

---

## ğŸ‰ é›†æˆå®Œæˆ

å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡,ä½ ç°åœ¨å¯ä»¥:
1. âœ… ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“
2. âœ… ä½¿ç”¨Qwen3-Embedding-4Bæ„å»ºå‘é‡ç´¢å¼•
3. âœ… ä½¿ç”¨Qwen3-Next-80B-A3B-Instructè¿›è¡Œæ™ºèƒ½é—®ç­”
4. âœ… ç®¡ç†å¤šä¸ªçŸ¥è¯†ç©ºé—´

**æœåŠ¡å™¨åœ°å€**: http://localhost:8000
**APIæ–‡æ¡£**: http://localhost:8000/docs

---

## ğŸ“ éœ€è¦å¸®åŠ©?

å¦‚æœä»ç„¶é‡åˆ°é—®é¢˜,è¯·æä¾›:
1. å®Œæ•´çš„é”™è¯¯æ—¥å¿—
2. `python verify_integration.py` çš„è¾“å‡º
3. è¿è¡Œ `python main.py` åçš„å‰50è¡Œæ—¥å¿—
